%
% Copyright Â© 2021 by Timothy S. Jones
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Timothy S. Jones.
%
% This work consists of the file tikzlibrarydna.code.tex.
%
\ProvidesFile{tikzlibrarydna.code}[2021/06/15 v0.0.1 DNA diagrams using TikZ]

\pgfkeys{/dna/.cd,
  coding sequence length/.initial=6mm,
}

\tikzset{
  feature/.style={draw, transform shape},
  coding sequence/.style={
    feature,
    shape=single arrow,
    minimum height=6mm,
    single arrow head extend=1mm,
    anchor=west
  },
  ribosome binding site/.style={
    feature,
    shape=semicircle,
    anchor=south,
    yshift=-0.5\pgflinewidth,
    inner sep=1pt,
    fill=black
  },
  promoter/.style={
    feature,
    shape=promoter,
    promoter arrow={Triangle[length=3pt,width=3pt]},
    anchor=south west,
    yshift=\pgflinewidth,
    minimum height=2mm,
    minimum width=2mm,
    inner sep=0
  },
  terminator/.style={
    feature,
    shape=terminator,
    anchor=south,
    yshift=0.5\pgflinewidth,
    minimum height=2mm,
    minimum width=2mm,
    inner sep=0
  },
  line cap=rect,
}%

\def\tikzdna@dnaplot{%
  \pgfutil@ifnextchar[{\tikzdna@dnaplot@}{\tikzdna@dnaplot@[]}
}%

% #1: \dnaplot [...]
\def\tikzdna@dnaplot@[#1]{%
  \pgfutil@ifnextchar f{\tikzdna@dnaplot@features}{%
    \pgfutil@ifnextchar r{\tikzdna@dnaplot@regulation}{%
      \tikzdna@dnaplot@features features%
    }%
  }%
}%

\def\tikzdna@dnaplot@features@done{%
}%

\def\tikzdna@dnaplot@features features{%
  \pgfutil@ifnextchar[{\tikzdna@dnaplot@features@}{\tikzdna@dnaplot@features@[]}%
}%

\def\tikzdna@dnaplot@features@[#1]{%
  \tikzdna@dnaplot@features@normal@main%
}%

\long\def\tikzdna@dnaplot@features@normal@main#1{%
  \tikzdna@dnaplot@features@parse@group{#1}%
  \tikzdna@dnaplot@main@done%
}%

\long\def\tikzdna@dnaplot@features@parse@group#1{%
  \let\tikzdna@dnaplot@features@group@c\pgfutil@empty%
  \let\tikzdna@dnaplot@features@group@cont\pgfutil@empty%
  \let\tikzdna@dnaplot@features@group@conta\pgfutil@empty%
  \tikzdna@dnaplot@features@group@check#1\par\pgf@stop@eogroup%
}%

\def\tikzdna@dnaplot@features@group@check{%
  \pgfutil@ifnextchar[\tikzdna@dnaplot@features@group@opt{\tikzdna@dnaplot@features@group@opt[]}%
}%

\def\tikzdna@dnaplot@features@group@opt[#1]{%
  \let\tikzdna@dnaplot@features@parse@extras\pgfutil@empty%
  \expandafter\tikzdna@dnaplot@features@par\tikzdna@dnaplot@features@parse@extras
}%

\def\tikzdna@dnaplot@features@par{%
  \pgfutil@ifnextchar\bgroup{\tikzdna@dnaplot@features@par@@}{\tikzdna@dnaplot@features@par@}%
}%

\long\def\tikzdna@dnaplot@features@par@#1\par{%
  \pgfutil@ifnextchar\pgf@stop@eogroup{%
    \expandafter\tikzdna@dnaplot@features@encloser\tikzdna@dnaplot@features@group@c#1[}{%
    \expandafter\def\expandafter\tikzdna@dnaplot@features@group@c\expandafter{\tikzdna@dnaplot@features@group@c#1}%
    \tikzdna@dnaplot@features@par%
  }%
}%

\long\def\tikzdna@dnaplot@features@par@@#1{%
  \expandafter\def\expandafter\tikzdna@dnaplot@features@group@c\expandafter{\tikzdna@dnaplot@features@group@c{#1}}%
  \tikzdna@dnaplot@features@par
}%


%
% Replace ...[...]... by ...[{...}]...
%
\def\tikzdna@dnaplot@features@encloser{%
  \pgfutil@ifnextchar\bgroup{\tikzdna@dnaplot@features@encloser@@}{\tikzdna@dnaplot@features@encloser@}%
}%

\def\tikzdna@dnaplot@features@encloser@#1[{%
  \pgfutil@ifnextchar\pgf@stop@eogroup{%
    \expandafter\tikzdna@dnaplot@features@semi\tikzdna@dnaplot@features@group@cont#1;%
  }{%
    \expandafter\def\expandafter\tikzdna@dnaplot@features@group@cont\expandafter{\tikzdna@dnaplot@features@group@cont#1[}%
    \tikzdna@dnaplot@features@encloser@cont%
  }%
}%

\def\tikzdna@dnaplot@features@encloser@cont#1]#2[{%
  \pgfutil@ifnextchar\pgf@stop@eogroup{%
    \expandafter\tikzdna@dnaplot@features@semi\tikzdna@dnaplot@features@group@cont{#1}]#2;}{%
    \expandafter\def\expandafter\tikzdna@dnaplot@features@group@cont\expandafter{\tikzdna@dnaplot@features@group@cont{#1}]#2[}%
    \tikzdna@dnaplot@features@encloser@cont}%
}%

\def\tikzdna@dnaplot@features@encloser@@#1{%
  \expandafter\def\expandafter\tikzdna@dnaplot@features@group@cont\expandafter{\tikzdna@dnaplot@features@group@cont{#1}}%
  \tikzdna@dnaplot@features@encloser%
}%

%
% Replace ; by ,
%
\def\tikzdna@dnaplot@features@semi{%
  \pgfutil@ifnextchar\bgroup{\tikzdna@dnaplot@features@semi@@}{\tikzdna@dnaplot@features@semi@}%
}%

\def\tikzdna@dnaplot@features@semi@#1;{%
  \pgfutil@ifnextchar\pgf@stop@eogroup{%
    \expandafter\tikzdna@dnaplot@features@main@parser\tikzdna@dnaplot@features@group@conta#1,}{%
    \expandafter\def\expandafter\tikzdna@dnaplot@features@group@conta\expandafter{\tikzdna@dnaplot@features@group@conta#1,}%
    \tikzdna@dnaplot@features@semi%
  }%
}%

\def\tikzdna@dnaplot@features@semi@@#1{%
  \expandafter\def\expandafter\tikzdna@dnaplot@features@group@conta\expandafter{\tikzdna@dnaplot@features@group@conta{#1}}%
  \tikzdna@dnaplot@features@semi%
}%

\def\tikzdna@dnaplot@features@main@parser{%
  \pgfutil@ifnextchar\bgroup{\tikzdna@dnaplot@features@protect@group}{\tikzdna@dnaplot@features@main@parser@cont}%
}%

\def\tikzdna@dnaplot@features@protect@group#1{% skip space
  \pgfutil@ifnextchar\relax{\tikzdna@dnaplot@features@main@parser@cont{{#1}}}{\tikzdna@dnaplot@features@main@parser@cont{{#1}}}%
}%

\def\tikzdna@dnaplot@features@main@parser@cont{\tikzdna@dnaplot@features@main@parser@cont@normal}%

\def\tikzdna@dnaplot@features@main@parser@cont@normal#1,{%
  \tikzdna@dnaplot@features@parse@one#1-\pgf@stop@eodashes%
}%

\def\tikzdna@dnaplot@features@parse@one{%
  \pgfutil@ifnextchar\bgroup\tikzdna@dnaplot@features@scope\tikzdna@dnaplot@features@node%
}%

\def\tikzdna@dnaplot@main@done{%
}%

\def\tikzdna@dnaplot@regulation regulation{%
  \pgfutil@ifnextchar[{\tikzdna@dnaplot@regulation@}{\tikzdna@dnaplot@regulation@[]}%
}%

\def\tikzdna@dnaplot@regulation@[#1]#2;{%
}%

\pgfutil@IfUndefined{tikzaddtikzonlycommandshortcutlet}{%
  \def\tikzaddtikzonlycommandshortcutlet#1#2{%
    \expandafter\def\expandafter\tikz@installcommands\expandafter{\tikz@installcommands%
      \let#1=#2%
    }%
  }%
}{}%

\tikzaddtikzonlycommandshortcutlet\dnaplot\tikzdna@dnaplot%
